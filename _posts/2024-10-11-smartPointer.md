---
title: C++ μ¤λ§νΈ ν¬μΈν„°
author: RePro
date: 2024-10-11 10:00:00 +0900
categories: [Programming, C++]
tags: [c++]
---

# C++ μ¤λ§νΈ ν¬μΈν„° μ •λ¦¬

## π“ 1. μ¤λ§νΈ ν¬μΈν„°(Smart Pointer)λ€?

μ¤λ§νΈ ν¬μΈν„°λ” **C++μ—μ„ λ©”λ¨λ¦¬λ¥Ό μλ™μΌλ΅ κ΄€λ¦¬**ν•λ” ν¬μΈν„°μ…λ‹λ‹¤. μΌλ°μ μΈ `new/delete` κΈ°λ°μ λ©”λ¨λ¦¬ κ΄€λ¦¬λ¥Ό λ€μ²΄ν•λ©°, **λ©”λ¨λ¦¬ λ„μ λ°©μ§€ λ° μ•μ •μ μΈ λ©”λ¨λ¦¬ ν•΄μ  κΈ°λ¥**μ„ μ κ³µν•©λ‹λ‹¤.

C++98μ—μ„λ” `std::auto_ptr`μ΄ λ„μ…λμ—μ§€λ§, μ„¤κ³„μƒμ λ¬Έμ λ΅ μΈν•΄ **C++11 μ΄ν›„ `std::unique_ptr`, `std::shared_ptr`, `std::weak_ptr`λ΅ λ€μ²΄**λμ—μµλ‹λ‹¤.

---

## β… 2. μ£Όμ” μ¤λ§νΈ ν¬μΈν„° μΆ…λ¥

### **2.1 `std::unique_ptr` (λ‹¨λ… μ†μ , λ³µμ‚¬ λ¶κ°€)**
- λ‹¨ ν•λ‚μ μ¤λ§νΈ ν¬μΈν„°λ§ νΉμ • κ°μ²΄λ¥Ό μ†μ ν•  μ μμ.
- **λ³µμ‚¬ λ¶κ°€λ¥**, λ€μ‹  `std::move()`λ¥Ό μ‚¬μ©ν•μ—¬ μ†μ κ¶ μ΄λ™ κ°€λ¥.

#### π”Ή μ‚¬μ© μμ 
```cpp
#include <iostream>
#include <memory>

int main() {
    std::unique_ptr<int> ptr = std::make_unique<int>(10);
    std::cout << *ptr << std::endl;  // μ¶λ ¥: 10
    
    std::unique_ptr<int> ptr2 = std::move(ptr);  // μ†μ κ¶ μ΄λ™
    std::cout << (ptr ? "ptr is valid" : "ptr is null") << std::endl;
}
```

#### π“ νΉμ§•
- **`std::move()`λ¥Ό μ‚¬μ©ν•μ—¬ μ†μ κ¶ μ΄λ™ κ°€λ¥**.
- **λ²”μ„λ¥Ό λ²—μ–΄λ‚λ©΄ μλ™μΌλ΅ λ©”λ¨λ¦¬ ν•΄μ **.
- **λ°°μ—΄(`T[]`)λ„ κ΄€λ¦¬ κ°€λ¥** β†’ `std::unique_ptr<int[]> arr(new int[10]);`

---

### **2.2 `std::shared_ptr` (κ³µμ  μ†μ , μ°Έμ΅° μΉ΄μ΄νΈ)**
- **μ—¬λ¬ κ°μ ν¬μΈν„°κ°€ κ°™μ€ κ°μ²΄λ¥Ό κ³µμ  κ°€λ¥**.
- **μ°Έμ΅° μΉ΄μ΄νΈ(`use_count()`)** λ¥Ό μ‚¬μ©ν•μ—¬ λ§μ§€λ§‰ `shared_ptr`κ°€ μ†λ©Έλ  λ• κ°μ²΄ μλ™ μ‚­μ .

#### π”Ή μ‚¬μ© μμ 
```cpp
#include <iostream>
#include <memory>

int main() {
    std::shared_ptr<int> ptr1 = std::make_shared<int>(10);
    std::shared_ptr<int> ptr2 = ptr1;  // μ°Έμ΅° μΉ΄μ΄νΈ μ¦κ°€
    
    std::cout << *ptr1 << " ref count: " << ptr1.use_count() << std::endl;
}
```

#### π“ νΉμ§•
- **μ—¬λ¬ ν¬μΈν„°κ°€ ν•λ‚μ κ°μ²΄λ¥Ό κ³µμ  κ°€λ¥**.
- **κ°μ²΄κ°€ λ” μ΄μƒ μ‚¬μ©λμ§€ μ•μ„ λ•(`use_count() == 0`) μλ™μΌλ΅ μ‚­μ **.
- `std::make_shared<T>()`λ¥Ό μ‚¬μ©ν•λ©΄ **λ©”λ¨λ¦¬ ν• λ‹Ή λΉ„μ© κ°μ†**.

--- 

## `std::shared_ptr` κ°μ” λ° μ£Όμμ 

`std::shared_ptr`λ” C++11μ—μ„ λ„μ…λ μ¤λ§νΈ ν¬μΈν„°λ΅, μ°Έμ΅° μΉ΄μ΄νΈλ¥Ό ν†µν•΄ λ©”λ¨λ¦¬ κ΄€λ¦¬λ¥Ό μλ™ν™”ν•©λ‹λ‹¤. κ·Έλ¬λ‚ λ¨λ“  μƒν™©μ—μ„ μ΄μƒμ μ΄μ§€ μ•μΌλ©°, λ‹¨μ κ³Ό λ‚΄λ¶€ κµ¬μ΅°λ¥Ό μ΄ν•΄ν•κ³  μ μ ν μ‚¬μ©ν•λ” κ²ƒμ΄ μ¤‘μ”ν•©λ‹λ‹¤.


## 1. μ¥μ 

- μ°Έμ΅° μΉ΄μ΄νΈλ¥Ό κΈ°λ°μΌλ΅ ν• **μλ™ λ©”λ¨λ¦¬ κ΄€λ¦¬**
- λ³µμ κ°μ²΄μ—μ„ λ™μΌ λ¦¬μ†μ¤λ¥Ό κ³µμ  κ°€λ¥
- λ©”λ¨λ¦¬ λ„μλ¥Ό μ¤„μ΄λ” λ° ν¨κ³Όμ 

---

## 2. λ‹¨μ  λ° μ£Όμμ‚¬ν•­

### 2.1 μν™ μ°Έμ΅° λ¬Έμ  (Circular Reference)

- λ‘ κ°μ²΄κ°€ μ„λ΅λ¥Ό `shared_ptr`λ΅ μ°Έμ΅°ν•λ©΄ μ°Έμ΅° μΉ΄μ΄νΈκ°€ 0μ΄ λμ§€ μ•μ•„ **λ©”λ¨λ¦¬ λ„μ** λ°μƒ

#### μμ‹
```cpp
struct A;
struct B;

struct A {
    std::shared_ptr<B> b;
};

struct B {
    std::shared_ptr<A> a;
};
```
- ν•΄κ²°: ν•μ½μ€ `std::weak_ptr`λ΅ λ³€κ²½

---

### 2.2 μ μ–΄ λΈ”λ΅ μ¤λ²„ν—¤λ“

- κ°μ²΄ μ™Έμ— **μ μ–΄ λΈ”λ΅(control block)**μ΄ μ¶”κ°€λ΅ λ©”λ¨λ¦¬μ— μ΅΄μ¬
- μ μ–΄ λΈ”λ΅μ—λ” μ°Έμ΅° μΉ΄μ΄νΈ, deleter λ“±μ΄ ν¬ν•¨λ¨ β†’ **λ©”λ¨λ¦¬ μ‚¬μ©λ‰ μ¦κ°€**

---

### 2.3 μ„±λ¥ μ¤λ²„ν—¤λ“

- μ°Έμ΅° μΉ΄μ΄νΈ μ—°μ‚°μ€ **thread-safe** β†’ λ‚΄λ¶€μ μΌλ΅ μ›μ μ—°μ‚° μ‚¬μ©
- λ©€ν‹°μ¤λ λ“ ν™κ²½μ—μ„λ” **shared_ptrμ μƒμ„±/λ³µμ‚¬/μ†λ©Έμ΄ μ„±λ¥ μ €ν•** μ λ° κ°€λ¥

---

### 2.4 μ†μ κ¶μ΄ λ¶λ¶„λ…

- μ—¬λ¬ κ³³μ—μ„ κ°μ²΄λ¥Ό μ†μ ν•  μ μμ–΄, κ°μ²΄μ **μƒλ… μ£ΌκΈ° μμΈ΅μ΄ μ–΄λ ¤μ›€**
- λ¦¬μ†μ¤ μƒλ…μ£ΌκΈ°λ¥Ό λ…ν™•ν•κ² μ μ–΄ν•΄μ•Ό ν•λ‹¤λ©΄ `unique_ptr`μ΄ μ ν•©ν•¨

---

### 2.5 μλ»λ μ‚¬μ©: shared_ptr(p.get())

```cpp
std::shared_ptr<Foo> a(new Foo);
std::shared_ptr<Foo> b(a.get()); // μ„ν—: μ„λ΅ λ‹¤λ¥Έ μ μ–΄ λΈ”λ΅!
```
- `a`μ™€ `b`λ” μ„λ΅ λ‹¤λ¥Έ μ μ–΄ λΈ”λ΅μ„ κ°€μ§ β†’ **double delete μ„ν—**


---

### **2.3 `std::weak_ptr` (μν™ μ°Έμ΅° λ°©μ§€, μ°Έμ΅° μΉ΄μ΄νΈ μ¦κ°€ μ—†μ)**
- `shared_ptr`μ **μ°Έμ΅° μΉ΄μ΄νΈλ¥Ό μ¦κ°€μ‹ν‚¤μ§€ μ•κ³  κ°μ²΄λ¥Ό μ°Έμ΅°**ν•  μ μμ.
- **κ°μ²΄κ°€ μ΅΄μ¬ν•λ”μ§€(`expired()`) ν™•μΈ ν›„ μ‚¬μ© κ°€λ¥**.

#### π”Ή μ‚¬μ© μμ 
```cpp
#include <iostream>
#include <memory>

int main() {
    std::weak_ptr<int> wptr;
    {
        std::shared_ptr<int> sptr = std::make_shared<int>(100);
        wptr = sptr;  // μ°Έμ΅° μΉ΄μ΄νΈ μ¦κ°€ μ•ν•¨
    } // sptrμ΄ λ²”μ„λ¥Ό λ²—μ–΄λ‚λ©΄ κ°μ²΄ μ†λ©Έ

    if (auto sp = wptr.lock()) {
        std::cout << *sp << std::endl;
    } else {
        std::cout << "κ°μ²΄κ°€ μ†λ©Έλ¨" << std::endl;
    }
}
```

#### π“ νΉμ§•
- `shared_ptr`κ³Ό ν•¨κ» μ‚¬μ©ν•μ—¬ **μν™ μ°Έμ΅°(Circular Reference) λ°©μ§€**.
- `lock()`μ„ μ‚¬μ©ν•μ—¬ **μ ν¨ν• `shared_ptr`λ¥Ό μ–»μ„ μ μμ**.

---

## β… 3. `std::auto_ptr` (C++17μ—μ„ μ κ±°λ¨)

`std::auto_ptr`μ€ **C++98μ—μ„ λ„μ…λ μ¤λ§νΈ ν¬μΈν„°**μ§€λ§, **λ³µμ‚¬ μ‹ μ†μ κ¶μ΄ κ°•μ λ΅ μ΄λ™λλ” λ¬Έμ **λ΅ μΈν•΄ **C++11μ—μ„ μ‚¬μ©μ΄ λΉ„μ¶”μ²λκ³ , C++17μ—μ„ μ™„μ „ν μ κ±°λ¨**.

#### π”Ή `std::auto_ptr` μ‚¬μ© μμ  (λΉ„μ¶”μ²)
```cpp
#include <iostream>
#include <memory>

int main() {
    std::auto_ptr<int> ptr1(new int(10));
    std::auto_ptr<int> ptr2 = ptr1;  // ptr1μ μ†μ κ¶μ΄ ptr2λ΅ μ΄λ™
    
    std::cout << (ptr1.get() == nullptr ? "ptr1 is null" : "ptr1 is valid") << std::endl;
}
```
π“ `std::auto_ptr` λ€μ‹  **`std::unique_ptr` λλ” `std::shared_ptr`λ¥Ό μ‚¬μ©ν•  κ²ƒ**.

---

## β… 4. λ¶€κ°€μ μΈ μ¤λ§νΈ ν¬μΈν„°

### **4.1 `boost::scoped_ptr` (λ‹¨μν• `unique_ptr`)**
- Boost λΌμ΄λΈλ¬λ¦¬μ—μ„ μ κ³µν•λ” μ¤λ§νΈ ν¬μΈν„°.
- `unique_ptr`κ³Ό μ μ‚¬ν•μ§€λ§, **μ†μ κ¶ μ΄λ™(`std::move()`)μ΄ λ¶κ°€λ¥**.

### **4.2 `boost::intrusive_ptr` (μ‚¬μ©μ μ •μ μ°Έμ΅° μΉ΄μ΄νΈ)**
- `shared_ptr`κ³Ό μ μ‚¬ν•μ§€λ§, **μ°Έμ΅° μΉ΄μ΄νΈλ¥Ό μ‚¬μ©μκ°€ μ§μ ‘ κ΄€λ¦¬**.

### **4.3 `boost::shared_array` (λ°°μ—΄ κ΄€λ¦¬ μ¤λ§νΈ ν¬μΈν„°)**
- `shared_ptr`μ λ°°μ—΄ λ²„μ „.
- C++11 μ΄ν›„μ—λ” `std::unique_ptr<T[]>`λ΅ λ€μ²΄ κ°€λ¥.

---

## β… 5. μ¤λ§νΈ ν¬μΈν„° λΉ„κµ

| μ¤λ§νΈ ν¬μΈν„° | μ†μ κ¶ | μ°Έμ΅° μΉ΄μ΄νΈ | μ£Όμ” νΉμ§• |
|--------------|--------|------------|------------|
| **`std::unique_ptr`** | **λ‹¨λ… μ†μ ** | β μ—†μ | λ³µμ‚¬ λ¶κ°€, μ΄λ™(`std::move()`) κ°€λ¥ |
| **`std::shared_ptr`** | **κ³µμ  μ†μ ** | β… μμ | μ°Έμ΅° μΉ΄μ΄νΈ μ¦κ°€/κ°μ† |
| **`std::weak_ptr`** | **κ³µμ  μ†μ  (X)** | β μ—†μ | `shared_ptr`μ μ°Έμ΅° μΉ΄μ΄νΈ μ¦κ°€ μ—†μ΄ μ°Έμ΅° |
| **`std::auto_ptr`** | **λ‹¨λ… μ†μ  (λΉ„μ¶”μ²)** | β μ—†μ | C++17μ—μ„ μ κ±°λ¨ |

---

## β… 6. κ²°λ΅ 

β” **μ¤λ§νΈ ν¬μΈν„°λ” `new/delete` μ—†μ΄ μλ™ λ©”λ¨λ¦¬ κ΄€λ¦¬λ¥Ό μ§€μ›**.  
β” **C++11 μ΄ν›„ `std::unique_ptr`, `std::shared_ptr`, `std::weak_ptr`μ„ μ‚¬μ©ν•΄μ•Ό ν•¨**.  
β” **`std::auto_ptr`μ€ C++17μ—μ„ μ κ±°λμ—μΌλ©°, `std::unique_ptr`λ΅ λ€μ²΄**.  
β” **`std::shared_ptr`μ„ μ‚¬μ©ν•  λ•λ” μν™ μ°Έμ΅°λ¥Ό λ°©μ§€ν•κΈ° μ„ν•΄ `std::weak_ptr`μ„ ν™μ©**.  
